# 8.4 ç¶²è·¯å®‰å…¨åŸºç¤

åœ¨å‰é¢çš„ç« ç¯€ä¸­ï¼Œæˆ‘å€‘å­¸ç¿’äº† HTTP çš„åŸºæœ¬æ¦‚å¿µå’Œèªè­‰æ©Ÿåˆ¶ã€‚ç¾åœ¨ï¼Œè®“æˆ‘å€‘ä¾†äº†è§£æ›´å¤šé—œæ–¼ç¶²è·¯å®‰å…¨çš„é‡è¦çŸ¥è­˜ã€‚

## HTTPS åŸºç¤èªè­˜

### ä»€éº¼æ˜¯ HTTPSï¼Ÿ

![HTTPS æ¦‚å¿µåœ–](images/https-concept.svg)

æƒ³åƒä½ åœ¨é¤å»³é»é¤ï¼š
- HTTP å°±åƒæ˜¯åœ¨å¤§å»³è£¡å¤§è²å–Šå‡ºä½ çš„è¨‚å–®
- HTTPS å‰‡åƒæ˜¯ç”¨å¯†ç¢¼ç°¿å¯«ä¸‹è¨‚å–®ï¼Œåªæœ‰æœå‹™ç”Ÿæ‰èƒ½çœ‹æ‡‚

HTTPS = HTTP + SSL/TLSï¼ˆåŠ å¯†å±¤ï¼‰

### ç‚ºä»€éº¼éœ€è¦ HTTPSï¼Ÿ

![HTTPS å®‰å…¨æ€§æ¦‚å¿µåœ–](images/https-benefits.svg)

1. ä¿è­·æ•¸æ“šéš±ç§
   - é˜²æ­¢å¯†ç¢¼è¢«å·çœ‹
   - ä¿è­·ä¿¡ç”¨å¡è³‡æ–™
   - ç¢ºä¿å€‹äººè³‡æ–™å®‰å…¨

2. é˜²æ­¢æ•¸æ“šè¢«ç¯¡æ”¹
   - ç¢ºä¿æ”¶åˆ°çš„æ˜¯åŸå§‹æ•¸æ“š
   - é˜²æ­¢ä¸­é–“äººæ”»æ“Š

### å¦‚ä½•è­˜åˆ¥å®‰å…¨é€£æ¥ï¼Ÿ

1. ç€è¦½å™¨åœ°å€æ¬„çš„æ¨™è­˜ï¼š
```
ğŸ”’ https://www.example.com
```

2. SSL è­‰æ›¸è³‡è¨Šï¼š
   - é»æ“Šé–é ­åœ–æ¨™
   - æŸ¥çœ‹è­‰æ›¸è©³æƒ…
   - ç¢ºèªè­‰æ›¸æœ‰æ•ˆæ€§

## åŸºæœ¬å®‰å…¨æ„è­˜åŸ¹é¤Š

### 1. å¯†ç¢¼çš„å®‰å…¨å­˜å„²å’Œå‚³è¼¸

æ°¸é ä¸è¦ï¼š
```javascript
// âŒ æ˜æ–‡å­˜å„²å¯†ç¢¼
const password = "mypassword123";

// âŒ ç°¡å–®åŠ å¯†
const password = btoa("mypassword123");  // Base64 ç·¨ç¢¼
```

æ‡‰è©²ï¼š
```javascript
// âœ… ä½¿ç”¨å°ˆæ¥­çš„åŠ å¯†å‡½æ•¸
const hashedPassword = await bcrypt.hash(password, 10);

// âœ… ä½¿ç”¨ HTTPS å‚³è¼¸
fetch('https://api.example.com/login', {
    method: 'POST',
    body: JSON.stringify({ password })
});
```

### 2. å€‹äººè³‡æ–™çš„ä¿è­·

1. æ•¸æ“šæœ€å°åŒ–åŸå‰‡ï¼š
```javascript
// âŒ æ”¶é›†éå¤šè³‡æ–™
const userInfo = {
    name: "å°æ˜",
    idNumber: "A123456789",  // ä¸å¿…è¦çš„æ•æ„Ÿè³‡è¨Š
    creditCard: "1234-5678-9012-3456",  // ä¸å¿…è¦çš„æ•æ„Ÿè³‡è¨Š
    address: "å°åŒ—å¸‚..."
};

// âœ… åªæ”¶é›†å¿…è¦è³‡æ–™
const userInfo = {
    name: "å°æ˜",
    email: "user@example.com"
};
```

2. è³‡æ–™å­˜å–æ§åˆ¶ï¼š
```javascript
// âœ… è¨­ç½®é©ç•¶çš„æ¬Šé™
const userSchema = {
    name: { type: String, public: true },
    email: { type: String, private: true },
    notes: { type: String, role: ['admin', 'owner'] }
};
```

### 3. å¸¸è¦‹ç¶²è·¯é™·é˜±é˜²ç¯„

1. XSSï¼ˆè·¨ç«™è…³æœ¬æ”»æ“Šï¼‰é˜²è­·ï¼š
```javascript
// âŒ ç›´æ¥æ’å…¥ HTML
element.innerHTML = userInput;

// âœ… è½‰ç¾©ç‰¹æ®Šå­—ç¬¦
element.textContent = userInput;
// æˆ–
element.innerHTML = escapeHtml(userInput);
```

2. SQL æ³¨å…¥é˜²è­·ï¼š
```javascript
// âŒ ç›´æ¥æ‹¼æ¥ SQL
const query = `SELECT * FROM users WHERE id = ${userId}`;

// âœ… ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢
const query = `SELECT * FROM users WHERE id = ?`;
db.query(query, [userId]);
```

## API å®‰å…¨ä½¿ç”¨æº–å‰‡

### 1. API Key çš„æ­£ç¢ºä½¿ç”¨

```javascript
// âŒ ç›´æ¥åœ¨ä»£ç¢¼ä¸­å¯«å…¥ API Key
const apiKey = "sk_test_1234567890";

// âœ… ä½¿ç”¨ç’°å¢ƒè®Šé‡
const apiKey = process.env.API_KEY;

// âœ… åœ¨è«‹æ±‚ä¸­æ­£ç¢ºä½¿ç”¨
fetch('https://api.service.com/data', {
    headers: {
        'Authorization': `Bearer ${process.env.API_KEY}`
    }
});
```

### 2. æ•æ„Ÿè³‡è¨Šçš„è™•ç†

1. æ—¥èªŒè¨˜éŒ„ï¼š
```javascript
// âŒ è¨˜éŒ„æ•æ„Ÿä¿¡æ¯
console.log(`User ${email} logged in with password ${password}`);

// âœ… å®‰å…¨çš„æ—¥èªŒè¨˜éŒ„
console.log(`User ${email} logged in successfully`);
logger.info('Login successful', { userId, timestamp });
```

2. éŒ¯èª¤è™•ç†ï¼š
```javascript
// âŒ è¿”å›è©³ç´°éŒ¯èª¤
catch (err) {
    res.status(500).json({ 
        error: err.stack,
        query: sql,
        params: userInput 
    });
}

// âœ… è¿”å›å®‰å…¨çš„éŒ¯èª¤ä¿¡æ¯
catch (err) {
    res.status(500).json({ 
        message: 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    });
    // åœ¨æœå‹™å™¨ç«¯è¨˜éŒ„è©³ç´°éŒ¯èª¤
    logger.error('Database error', err);
}
```

## é–‹ç™¼ç’°å¢ƒå®‰å…¨é…ç½®

### 1. åŸºæœ¬å®‰å…¨æª¢æŸ¥æ¸…å–®

- [ ] ä½¿ç”¨ HTTPS
- [ ] è¨­ç½®å®‰å…¨çš„ HTTP æ¨™é ­
- [ ] å¯¦æ–½é€Ÿç‡é™åˆ¶
- [ ] å•Ÿç”¨ CSRF ä¿è­·
- [ ] é…ç½®å®‰å…¨çš„ cookie é¸é …

### 2. å®‰å…¨æ¨™é ­é…ç½®

```javascript
// Express.js ç¤ºä¾‹
app.use(helmet());  // æ·»åŠ å®‰å…¨æ¨™é ­

// æ‰‹å‹•é…ç½®
app.use((req, res, next) => {
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('Content-Security-Policy', "default-src 'self'");
    next();
});
```

### 3. é–‹ç™¼ç’°å¢ƒæ³¨æ„äº‹é …

1. ç’°å¢ƒè®Šé‡ç®¡ç†ï¼š
```bash
# .env.exampleï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
API_KEY=your_api_key_here
DB_PASSWORD=your_db_password_here

# .envï¼ˆæœ¬åœ°é–‹ç™¼ï¼Œä¸é€²å…¥ç‰ˆæœ¬æ§åˆ¶ï¼‰
API_KEY=actual_api_key
DB_PASSWORD=actual_password
```

2. ä¾è³´åŒ…å®‰å…¨ï¼š
```bash
# æª¢æŸ¥ä¾è³´åŒ…å®‰å…¨æ€§
npm audit

# æ›´æ–°æœ‰å®‰å…¨å•é¡Œçš„åŒ…
npm audit fix
```

## ç·´ç¿’é¡Œ
1. æª¢æŸ¥ä¸€å€‹ç¶²ç«™çš„ HTTPS é…ç½®ï¼Œåˆ†æå…¶å®‰å…¨è­‰æ›¸
2. å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ XSS é˜²è­·å‡½æ•¸
3. å¯©æŸ¥ä½ çš„é …ç›®ï¼Œæ‰¾å‡ºå¯èƒ½çš„å®‰å…¨éš±æ‚£

## ä¸‹ä¸€æ­¥
ç¾åœ¨ä½ å·²ç¶“äº†è§£äº†åŸºæœ¬çš„ç¶²è·¯å®‰å…¨çŸ¥è­˜ï¼Œå»ºè­°ä½ ï¼š
1. æŒçºŒé—œæ³¨å®‰å…¨æ›´æ–°
2. åƒèˆ‡å®‰å…¨ç¤¾ç¾¤
3. å¯¦è¸æ‰€å­¸çŸ¥è­˜åˆ°å¯¦éš›é …ç›®ä¸­ 